/**
* ownCloud - Dashboards plugin
*
* @author Xavier Beurois
* @copyright 2012 Xavier Beurois www.djazz-lab.net
* 
* This library is free software; you can redistribute it and/or
* modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
* License as published by the Free Software Foundation; either 
* version 3 of the License, or any later version.
* 
* This library is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU AFFERO GENERAL PUBLIC LICENSE for more details.
*  
* You should have received a copy of the GNU Lesser General Public 
* License along with this library.  If not, see <http://www.gnu.org/licenses/>.
* 
*/

$(document).ready(function(){
	var dashsel=null;
	function load_dashboard(a,f,j,n){
		$('#dashboards_panel div.dashboards_panel_main div#'+dashsel).removeClass('dashboard-elt-none');
		$('#dashboards_panel div.dashboards_panel_main div#'+dashsel).load(oc_appswebroot+'/apps/'+a+'/dashboards/'+f+' div.dashelt_inner', function(r,s,x){
			if(j==1){
				$.getScript(oc_appswebroot+'/apps/'+a+'/dashboards/'+f.substr(0, f.lastIndexOf('.'))+'.js');
			}
			$('#dashboards_panel div.dashboards_panel_main div#'+dashsel+' div.dashelt_inner h1').append('<img class="edit" src="'+OC.imagePath('core','actions/settings.svg')+'" />');
			$('#dashboards_panel div.dashboards_panel_main div#'+dashsel+' div.dashelt_inner h1 img.edit').bind('click',function(){
				$('#dashboards_list').dialog('open');
			});
			if(s!='error' && n!=0){
				$.ajax({
					type:'POST',
					dataType:'json',
				  	url:OC.linkTo('dashboards','ajax/setUserDashboard.php'),
				  	data:{d:dashsel,app:a,file:f,js:j},
				  	async:true
				});
			}
		});
	}
	$('#header form.searchbox').before('<img id="dashboard_link" src="'+OC.imagePath('dashboards','dashboard.png')+'" />');
	$('#header').after('<div id="dashboards_panel"><div id="dashboards_list"></div><div class="dashboards_panel_main"></div></div>');
	$('#dashboards_list').dialog({
		autoOpen:false,
		show:'blind',
		modal:true,
		open:function(e,u){
			d=$(this);
			d.html('<img class="loader" src="'+OC.imagePath('dashboards','loader.gif')+'" />Loading dashboards list ...');
			$.ajax({
				type:'POST',
				dataType:'json',
			  	url:OC.linkTo('dashboards','ajax/getDashboardsList.php'),
			  	async:false,
			  	success:function(s){
			  		d.html('<div id="dashboards_list_container">'+s.r+'</div>');
			  		$('#dashboards_list_container div input[type="radio"]').bind('click',function(){
			  			load_dashboard($(this).attr('data-appid'),$(this).attr('data-file'),$(this).attr('data-js'),1);
			  			$('#dashboards_list').dialog('close');
			  		});
			  	}
			});
		}
	});
	$('#dashboard_link').bind('click',function(){
		if($('#dashboards_panel div.dashboards_panel_main').css('display') == 'none'){
			$('#dashboards_panel div.dashboards_panel_main').slideDown(300,function(){
				$('#dashboards_panel div.dashboards_panel_main').empty();
				for(i=1;i<5;i++){
		  			$('#dashboards_panel div.dashboards_panel_main').append('<div id="elt_'+i+'" class="dashboard-elt dashboard-elt-none"><img class="loader" src="'+OC.imagePath('dashboards','loader_black.gif')+'" /></div>');
		  		}
		  		$('#dashboards_panel div.dashboards_panel_main div.dashboard-elt-none').each(function(k,v){
		  			$.ajax({
						type:'POST',
						dataType:'json',
					  	url:OC.linkTo('dashboards','ajax/getUserDashboard.php'),
					  	data:{n:$(v).attr('id')},
					  	async:false,
					  	success:function(s){
					  		if(s.d){
						  		dashsel=$(v).attr('id');
						  		load_dashboard(s.d.d_appid,s.d.d_file,s.d.d_js,0);
					  		}else{
					  			$(v).html('<img class="new" src="'+OC.imagePath('dashboards','new.png')+'" /><p>Click to insert a dashboard !</p>');
					  			$(v).bind('click',function(){
					  				dashsel=$(v).attr('id');
					  				$('#dashboards_list').dialog('open');
					  			});
					  		}
					  	}
					});
		  		});
			});
		}else{
			$('#dashboards_panel div.dashboards_panel_main').empty();
			$('#dashboards_panel div.dashboards_panel_main').slideUp(300);
		}
	});
});
